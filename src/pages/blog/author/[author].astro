---
import { getCollection } from 'astro:content';
import Layout from '../../../layouts/Layout.astro';
import Header from '../../../components/Header.astro';
import Footer from '../../../components/Footer.astro';
import PostCard from '../../../components/blog/PostCard.astro';

// Define known authors with their info
const authorInfo: Record<string, { name: string; bio: string; avatar?: string }> = {
  'nodakmesh-team': {
    name: 'NodakMesh Team',
    bio: 'The NodakMesh team is building mesh network infrastructure across North Dakota. We write guides, reviews, and tutorials to help others get started with LoRa mesh networking.',
  },
  'josh': {
    name: 'Josh',
    bio: 'Mesh networking enthusiast and NodakMesh community member.',
  },
};

// Helper to slugify author names
function slugifyAuthor(author: string): string {
  return author.toLowerCase().replace(/\s+/g, '-');
}

export async function getStaticPaths() {
  const posts = await getCollection('blog');

  // Get unique authors
  const authors = [...new Set(posts.map(post => post.data.author).filter(Boolean))];

  return authors.map(author => ({
    params: { author: slugifyAuthor(author || 'unknown') },
    props: {
      authorName: author,
      authorSlug: slugifyAuthor(author || 'unknown'),
    },
  }));
}

const { authorName, authorSlug } = Astro.props;
const info = authorInfo[authorSlug] || { name: authorName, bio: '' };

// Get all posts by this author
const allPosts = await getCollection('blog');
const authorPosts = allPosts
  .filter(post => slugifyAuthor(post.data.author || '') === authorSlug)
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());
---

<Layout
  title={`${info.name} - NodakMesh Blog`}
  description={`Articles by ${info.name} on NodakMesh. ${info.bio}`}
  keywords={`${info.name}, NodakMesh author, mesh network articles, LoRa guides`}
>
  <Header slot="header" />

  <div class="pt-24 pb-16">
    <!-- Author Header -->
    <section class="py-12 border-b border-[--color-border]">
      <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Breadcrumb -->
        <nav class="flex items-center gap-2 text-sm text-[--color-text-muted] mb-6">
          <a href="/blog" class="hover:text-[--color-accent] transition-colors">Blog</a>
          <span>/</span>
          <span>Author</span>
        </nav>

        <div class="flex items-start gap-6">
          <!-- Avatar -->
          <div class="w-20 h-20 rounded-full bg-[--color-accent]/10 flex items-center justify-center flex-shrink-0">
            <span class="text-2xl font-bold text-[--color-accent]">
              {info.name.split(' ').map(n => n[0]).join('').slice(0, 2)}
            </span>
          </div>

          <div>
            <h1 class="text-3xl font-bold text-[--color-text-primary] mb-2">
              {info.name}
            </h1>
            {info.bio && (
              <p class="text-[--color-text-secondary] max-w-2xl">
                {info.bio}
              </p>
            )}
            <p class="text-sm text-[--color-text-muted] mt-3">
              {authorPosts.length} {authorPosts.length === 1 ? 'article' : 'articles'} published
            </p>
          </div>
        </div>
      </div>
    </section>

    <!-- Author Posts -->
    <section class="py-12">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <h2 class="text-2xl font-bold text-[--color-text-primary] mb-8">
          Articles by {info.name}
        </h2>

        {authorPosts.length > 0 ? (
          <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
            {authorPosts.map(post => (
              <PostCard
                title={post.data.title}
                description={post.data.description}
                date={post.data.date}
                author={post.data.author}
                category={post.data.category}
                slug={post.id}
                image={post.data.image}
              />
            ))}
          </div>
        ) : (
          <p class="text-[--color-text-muted]">No articles found.</p>
        )}

        <!-- Back to Blog -->
        <div class="mt-12">
          <a
            href="/blog"
            class="inline-flex items-center gap-2 text-[--color-text-secondary] hover:text-[--color-accent] transition-colors"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16l-4-4m0 0l4-4m-4 4h18" />
            </svg>
            Back to all posts
          </a>
        </div>
      </div>
    </section>
  </div>

  <Footer slot="footer" />
</Layout>
