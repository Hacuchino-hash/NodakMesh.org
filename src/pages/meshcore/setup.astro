---
import Layout from '../../layouts/Layout.astro';

const pageTitle = "MeshCore Device Setup Guide";
const pageDescription = "Complete guide to flashing and configuring MeshCore firmware on your device. Includes DFU mode instructions, drivers, and post-flash configuration.";

const devices = [
  {
    id: 'heltec-v3',
    name: 'Heltec V3 / WiFi LoRa 32',
    dfu: 'Hold BOOT button while plugging in USB, or hold BOOT and press RST',
    driver: { name: 'CP210x', url: 'https://www.silabs.com/developers/usb-to-uart-bridge-vcp-drivers' },
    notes: 'Most popular starter device. No special mode needed for most flashing.',
  },
  {
    id: 'heltec-v4',
    name: 'Heltec V4 / Vision Master',
    dfu: 'Hold BOOT button while plugging in USB, or hold BOOT and press RST',
    driver: { name: 'CH340', url: 'https://www.wch-ic.com/downloads/CH341SER_ZIP.html' },
    notes: 'Windows users MUST install CH340 driver first. Device won\'t be recognized without it.',
  },
  {
    id: 'heltec-capsule',
    name: 'Heltec Capsule Sensor V3',
    dfu: 'Hold BOOT button while plugging in USB',
    driver: { name: 'CP210x', url: 'https://www.silabs.com/developers/usb-to-uart-bridge-vcp-drivers' },
    notes: 'Ultra-compact tracker with GPS. Great for portable use.',
  },
  {
    id: 'heltec-t114',
    name: 'Heltec T114',
    dfu: 'Double-tap the reset button quickly to enter bootloader mode',
    driver: null,
    notes: 'nRF52840-based device. Shows as USB drive when in bootloader mode.',
  },
  {
    id: 'heltec-wireless-paper',
    name: 'Heltec Wireless Paper',
    dfu: 'Hold BOOT button while plugging in USB',
    driver: { name: 'CP210x', url: 'https://www.silabs.com/developers/usb-to-uart-bridge-vcp-drivers' },
    notes: 'E-ink display - great for low-power solar setups.',
  },
  {
    id: 't-beam',
    name: 'LilyGo T-Beam',
    dfu: 'Hold BOOT button while plugging in USB, or hold BOOT and press RST',
    driver: { name: 'CP210x', url: 'https://www.silabs.com/developers/usb-to-uart-bridge-vcp-drivers' },
    notes: 'Has built-in GPS and 18650 battery holder. Great for mobile nodes.',
  },
  {
    id: 't-deck',
    name: 'LilyGo T-Deck',
    dfu: 'Hold trackball button (press down on it) while plugging in USB',
    driver: { name: 'CP210x', url: 'https://www.silabs.com/developers/usb-to-uart-bridge-vcp-drivers' },
    notes: 'MUST enter DFU mode to flash. Has keyboard and touchscreen for standalone use.',
  },
  {
    id: 't-deck-plus',
    name: 'LilyGo T-Deck Plus',
    dfu: 'Hold trackball button (press down on it) while plugging in USB',
    driver: { name: 'CP210x', url: 'https://www.silabs.com/developers/usb-to-uart-bridge-vcp-drivers' },
    notes: 'MUST enter DFU mode to flash. Upgraded version with better display.',
  },
  {
    id: 't-pager',
    name: 'LilyGo T-Pager',
    dfu: 'Hold BOOT button while plugging in USB',
    driver: { name: 'CP210x', url: 'https://www.silabs.com/developers/usb-to-uart-bridge-vcp-drivers' },
    notes: 'Compact pager-style device with keyboard.',
  },
  {
    id: 't-echo',
    name: 'LilyGo T-Echo',
    dfu: 'Double-tap the reset button quickly to enter bootloader mode',
    driver: null,
    notes: 'nRF52840-based. Shows as USB drive in bootloader. E-ink display.',
  },
  {
    id: 'rak-wisblock',
    name: 'RAK WisBlock (RAK4631)',
    dfu: 'Double-tap the reset button quickly to enter bootloader mode',
    driver: null,
    notes: 'nRF52840-based modular system. Shows as USB drive when in bootloader.',
  },
  {
    id: 'rak-wismesh-pocket',
    name: 'RAK WisMesh Pocket',
    dfu: 'Double-tap the reset button quickly',
    driver: null,
    notes: 'Pre-built enclosed device. nRF52840-based.',
  },
  {
    id: 'rak-wismesh-tag',
    name: 'RAK WisMesh Tag',
    dfu: 'Double-tap the reset button quickly',
    driver: null,
    notes: 'Ultra-compact tracker. nRF52840-based.',
  },
  {
    id: 'wio-tracker',
    name: 'Seeed Wio Tracker 1110',
    dfu: 'Double-tap the reset button quickly to enter bootloader mode',
    driver: null,
    notes: 'nRF52840-based with GPS. Shows as USB drive in bootloader.',
  },
  {
    id: 'station-g2',
    name: 'Station G2',
    dfu: 'Hold BOOT button while plugging in USB',
    driver: { name: 'CP210x', url: 'https://www.silabs.com/developers/usb-to-uart-bridge-vcp-drivers' },
    notes: 'High-power base station. Great for home or repeater setups.',
  },
  {
    id: 'nano-g2-ultra',
    name: 'Nano G2 Ultra',
    dfu: 'Hold BOOT button while plugging in USB',
    driver: { name: 'CP210x', url: 'https://www.silabs.com/developers/usb-to-uart-bridge-vcp-drivers' },
    notes: 'Compact device with screen. Good balance of features.',
  },
];
---

<Layout title={pageTitle} description={pageDescription}>
  <main class="pt-24 pb-16">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">

      <!-- Header -->
      <div class="text-center mb-8">
        <h1 class="text-4xl font-bold mb-4">
          <span class="text-[--color-text-primary]">MeshCore</span>
          <span class="gradient-text">Device Setup</span>
        </h1>
        <p class="text-xl text-[--color-text-secondary] max-w-2xl mx-auto">
          Complete guide to flashing MeshCore firmware on your device
        </p>
      </div>

      <!-- IMPORTANT: Antenna Warning -->
      <div class="bg-red-500/10 border-2 border-red-500/50 rounded-2xl p-6 mb-8">
        <div class="flex items-start gap-4">
          <svg class="w-8 h-8 text-red-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
          <div>
            <h3 class="text-lg font-bold text-red-400 mb-2">IMPORTANT: Attach Antenna Before Powering On!</h3>
            <p class="text-[--color-text-secondary]">
              <strong class="text-red-300">Always connect an antenna to your device BEFORE plugging in USB or turning it on.</strong>
              Transmitting without an antenna can permanently damage the LoRa radio chip. Even a few seconds of transmission
              without an antenna can cause irreversible damage. This applies to flashing AND normal use.
            </p>
          </div>
        </div>
      </div>

      <!-- Quick Start -->
      <div class="bg-gradient-to-r from-blue-500/10 to-purple-500/10 border border-blue-500/30 rounded-2xl p-8 mb-12">
        <h2 class="text-2xl font-bold text-[--color-text-primary] mb-4">Quick Start</h2>
        <ol class="space-y-3 text-[--color-text-secondary]">
          <li class="flex gap-3">
            <span class="flex-shrink-0 w-7 h-7 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-bold">1</span>
            <span><strong>Install drivers</strong> if needed (see device-specific section below)</span>
          </li>
          <li class="flex gap-3">
            <span class="flex-shrink-0 w-7 h-7 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-bold">2</span>
            <span><strong>Put device in DFU/bootloader mode</strong> (varies by device)</span>
          </li>
          <li class="flex gap-3">
            <span class="flex-shrink-0 w-7 h-7 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-bold">3</span>
            <span><strong>Open the web flasher</strong> in Chrome or Edge browser</span>
          </li>
          <li class="flex gap-3">
            <span class="flex-shrink-0 w-7 h-7 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-bold">4</span>
            <span><strong>Select your device</strong> and click Flash</span>
          </li>
          <li class="flex gap-3">
            <span class="flex-shrink-0 w-7 h-7 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-bold">5</span>
            <span><strong>Configure settings</strong> after flashing (frequency, name, etc.)</span>
          </li>
        </ol>
        <a
          href="https://flasher.meshcore.co.uk"
          target="_blank"
          rel="noopener noreferrer"
          class="inline-flex items-center gap-2 mt-6 px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-xl transition-colors"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
          </svg>
          Open MeshCore Web Flasher
        </a>
      </div>

      <!-- Post-Flash Configuration -->
      <div class="bg-[--color-bg-secondary] border border-[--color-border] rounded-2xl p-8 mb-12">
        <h2 class="text-2xl font-bold text-[--color-text-primary] mb-4">Post-Flash Configuration</h2>
        <p class="text-[--color-text-secondary] mb-6">After flashing, configure your device using the MeshCore Configurator or companion app:</p>

        <div class="grid md:grid-cols-2 gap-6">
          <div class="bg-[--color-bg-tertiary] rounded-xl p-5">
            <h3 class="font-semibold text-[--color-text-primary] mb-3">Essential Settings</h3>
            <ul class="space-y-2 text-sm text-[--color-text-secondary]">
              <li class="flex items-start gap-2">
                <svg class="w-4 h-4 text-green-400 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                </svg>
                <span><strong>Frequency:</strong> 915 MHz (US/Canada), 868 MHz (EU), 433 MHz (other)</span>
              </li>
              <li class="flex items-start gap-2">
                <svg class="w-4 h-4 text-green-400 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                </svg>
                <span><strong>Node Name:</strong> Give your node a friendly name</span>
              </li>
              <li class="flex items-start gap-2">
                <svg class="w-4 h-4 text-green-400 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                </svg>
                <span><strong>Node Type:</strong> Client, Router, or Repeater</span>
              </li>
              <li class="flex items-start gap-2">
                <svg class="w-4 h-4 text-green-400 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                </svg>
                <span><strong>Location:</strong> Set coordinates for mapping</span>
              </li>
            </ul>
          </div>

          <div class="bg-[--color-bg-tertiary] rounded-xl p-5">
            <h3 class="font-semibold text-[--color-text-primary] mb-3">Companion Apps</h3>
            <ul class="space-y-2 text-sm text-[--color-text-secondary]">
              <li class="flex items-start gap-2">
                <svg class="w-4 h-4 text-blue-400 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M10 2a8 8 0 100 16 8 8 0 000-16zm1 11H9v-2h2v2zm0-4H9V5h2v4z"/>
                </svg>
                <span><strong>iOS:</strong> MeshCore app on App Store</span>
              </li>
              <li class="flex items-start gap-2">
                <svg class="w-4 h-4 text-green-400 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M10 2a8 8 0 100 16 8 8 0 000-16zm1 11H9v-2h2v2zm0-4H9V5h2v4z"/>
                </svg>
                <span><strong>Android:</strong> MeshCore app on Play Store</span>
              </li>
              <li class="flex items-start gap-2">
                <svg class="w-4 h-4 text-purple-400 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M10 2a8 8 0 100 16 8 8 0 000-16zm1 11H9v-2h2v2zm0-4H9V5h2v4z"/>
                </svg>
                <span><strong>Web:</strong> <a href="https://meshcore.liamcottle.net" target="_blank" class="text-blue-400 hover:underline">meshcore.liamcottle.net</a></span>
              </li>
            </ul>
          </div>
        </div>

        <div class="mt-6 p-4 bg-yellow-500/10 border border-yellow-500/30 rounded-xl">
          <p class="text-sm text-yellow-200">
            <strong>North Dakota Users:</strong> Use 915 MHz frequency. Join the NoDak Mesh network by connecting to existing nodes in your area!
          </p>
        </div>
      </div>

      <!-- Device-Specific Instructions -->
      <h2 class="text-2xl font-bold text-[--color-text-primary] mb-6">Device-Specific Instructions</h2>

      <div class="space-y-4">
        {devices.map((device) => (
          <details class="group bg-[--color-bg-secondary] border border-[--color-border] rounded-xl overflow-hidden">
            <summary class="flex items-center justify-between p-5 cursor-pointer hover:bg-[--color-bg-tertiary] transition-colors">
              <span class="font-semibold text-[--color-text-primary]">{device.name}</span>
              <svg class="w-5 h-5 text-[--color-text-muted] group-open:rotate-180 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </summary>
            <div class="px-5 pb-5 border-t border-[--color-border]">
              <div class="pt-4 space-y-4">
                <div>
                  <h4 class="text-sm font-semibold text-[--color-text-secondary] uppercase tracking-wide mb-2">DFU / Bootloader Mode</h4>
                  <p class="text-[--color-text-primary] bg-[--color-bg-tertiary] p-3 rounded-lg font-mono text-sm">{device.dfu}</p>
                </div>

                {device.driver && (
                  <div>
                    <h4 class="text-sm font-semibold text-[--color-text-secondary] uppercase tracking-wide mb-2">Required Driver</h4>
                    <a
                      href={device.driver.url}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="inline-flex items-center gap-2 text-blue-400 hover:text-blue-300 transition-colors"
                    >
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                      </svg>
                      Download {device.driver.name} Driver
                    </a>
                  </div>
                )}

                <div>
                  <h4 class="text-sm font-semibold text-[--color-text-secondary] uppercase tracking-wide mb-2">Notes</h4>
                  <p class="text-[--color-text-secondary]">{device.notes}</p>
                </div>
              </div>
            </div>
          </details>
        ))}
      </div>

      <!-- Repeater Setup Guide -->
      <div class="mt-12 bg-gradient-to-r from-purple-500/10 to-blue-500/10 border border-purple-500/30 rounded-2xl p-8 mb-12">
        <h2 class="text-2xl font-bold text-[--color-text-primary] mb-4">Setting Up a MeshCore Repeater</h2>
        <p class="text-[--color-text-secondary] mb-6">
          Repeaters extend mesh network coverage by forwarding messages. Here's how to configure a MeshCore repeater for optimal performance:
        </p>

        <div class="space-y-6">
          <div class="bg-[--color-bg-primary]/50 rounded-xl p-5">
            <h3 class="font-semibold text-[--color-text-primary] mb-3">1. Flash Repeater Firmware</h3>
            <p class="text-[--color-text-secondary] text-sm">
              In the MeshCore flasher, select your device and choose the <strong>Repeater</strong> firmware variant if available,
              or flash standard firmware and configure as repeater afterward.
            </p>
          </div>

          <div class="bg-[--color-bg-primary]/50 rounded-xl p-5">
            <h3 class="font-semibold text-[--color-text-primary] mb-3">2. Set RTC Admin Password</h3>
            <p class="text-[--color-text-secondary] text-sm mb-3">
              Configure an admin password to protect repeater settings from unauthorized changes.
              This is essential for public-facing repeaters.
            </p>
            <div class="bg-[--color-bg-tertiary] rounded-lg p-3 font-mono text-sm">
              Settings → Security → RTC Admin Password → [Set a strong password]
            </div>
          </div>

          <div class="bg-[--color-bg-primary]/50 rounded-xl p-5">
            <h3 class="font-semibold text-[--color-text-primary] mb-3">3. Enable Guest Access (No Password)</h3>
            <p class="text-[--color-text-secondary] text-sm mb-3">
              For public repeaters, allow guest access so anyone can connect and use the mesh:
            </p>
            <div class="bg-[--color-bg-tertiary] rounded-lg p-3 font-mono text-sm">
              Settings → Security → Guest Access → <strong>Enabled (No Password)</strong>
            </div>
            <p class="text-xs text-[--color-text-muted] mt-2">
              This allows anyone to use the repeater without authentication while keeping admin functions protected.
            </p>
          </div>

          <div class="bg-[--color-bg-primary]/50 rounded-xl p-5">
            <h3 class="font-semibold text-[--color-text-primary] mb-3">4. Configure Advertisement Settings</h3>
            <p class="text-[--color-text-secondary] text-sm mb-3">
              Set these recommended advertisement intervals to balance network visibility with airtime usage:
            </p>
            <div class="space-y-2">
              <div class="flex justify-between items-center bg-[--color-bg-tertiary] rounded-lg p-3">
                <span class="text-sm text-[--color-text-secondary]">Zero Hop Interval:</span>
                <span class="font-mono text-blue-400">60 minutes</span>
              </div>
              <div class="flex justify-between items-center bg-[--color-bg-tertiary] rounded-lg p-3">
                <span class="text-sm text-[--color-text-secondary]">Flood Interval:</span>
                <span class="font-mono text-blue-400">3 hours (180 minutes)</span>
              </div>
            </div>
            <p class="text-xs text-[--color-text-muted] mt-2">
              These settings reduce unnecessary network traffic while still allowing your repeater to be discovered.
            </p>
          </div>

          <div class="bg-[--color-bg-primary]/50 rounded-xl p-5">
            <h3 class="font-semibold text-[--color-text-primary] mb-3">5. Set Location (Optional but Recommended)</h3>
            <p class="text-[--color-text-secondary] text-sm">
              Set GPS coordinates so your repeater appears on mesh maps. This helps users find nodes and plan network coverage.
            </p>
          </div>
        </div>

        <div class="mt-6 p-4 bg-blue-500/10 border border-blue-500/30 rounded-xl">
          <p class="text-sm text-blue-200">
            <strong>Tip:</strong> Place repeaters at high elevations with clear line-of-sight for maximum coverage.
            A good antenna matters more than TX power!
          </p>
        </div>
      </div>

      <!-- Troubleshooting -->
      <div class="bg-[--color-bg-secondary] border border-[--color-border] rounded-2xl p-8">
        <h2 class="text-2xl font-bold text-[--color-text-primary] mb-6">Troubleshooting</h2>

        <div class="space-y-6">
          <div>
            <h3 class="font-semibold text-[--color-text-primary] mb-2">Device not detected?</h3>
            <ul class="list-disc list-inside text-[--color-text-secondary] space-y-1 ml-2">
              <li>Make sure you've installed the correct driver (see device section above)</li>
              <li>Try a different USB cable - data cables look the same as charge-only cables</li>
              <li>Try a different USB port, preferably USB 2.0</li>
              <li>Make sure the device is in DFU/bootloader mode before connecting</li>
            </ul>
          </div>

          <div>
            <h3 class="font-semibold text-[--color-text-primary] mb-2">Flash fails or times out?</h3>
            <ul class="list-disc list-inside text-[--color-text-secondary] space-y-1 ml-2">
              <li>Close any other apps that might be using the serial port</li>
              <li>Use Chrome or Edge browser (Firefox doesn't support Web Serial)</li>
              <li>Try pressing the reset button and re-entering DFU mode</li>
              <li>For nRF52 devices: Make sure you see it as a USB drive first</li>
            </ul>
          </div>

          <div>
            <h3 class="font-semibold text-[--color-text-primary] mb-2">Device boots but won't connect?</h3>
            <ul class="list-disc list-inside text-[--color-text-secondary] space-y-1 ml-2">
              <li>Check that you've set the correct frequency (915 MHz for US)</li>
              <li>Make sure Bluetooth is enabled on your phone</li>
              <li>Try restarting both the device and your phone</li>
              <li>Factory reset the device and reconfigure</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Back to Devices -->
      <div class="mt-8 text-center">
        <a
          href="/meshcore/devices"
          class="inline-flex items-center gap-2 text-[--color-text-secondary] hover:text-[--color-text-primary] transition-colors"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
          Back to MeshCore Devices
        </a>
      </div>

    </div>
  </main>
</Layout>
