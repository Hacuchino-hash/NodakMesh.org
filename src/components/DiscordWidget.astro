---
// Discord Widget Component
// Shows live member count from Discord widget API
// Requires widget to be enabled in Discord server settings

interface Props {
  showOnlineCount?: boolean;
  size?: 'sm' | 'md' | 'lg';
  className?: string;
}

const { showOnlineCount = true, size = 'md', className = '' } = Astro.props;

// Discord server ID
const DISCORD_SERVER_ID = '1440379238019497996';
const DISCORD_INVITE = 'JUBrZepkaM';

// Size classes
const sizeClasses = {
  sm: 'text-xs',
  md: 'text-sm',
  lg: 'text-base'
};
---

<div class={`discord-widget inline-flex items-center gap-2 ${sizeClasses[size]} ${className}`} data-invite={DISCORD_INVITE}>
  <span class="discord-online-dot w-2 h-2 rounded-full bg-green-500 animate-pulse hidden"></span>
  <span class="discord-member-count text-[--color-text-muted]">
    <!-- Fallback text shown while loading or if API fails -->
    <slot>Join our Discord community</slot>
  </span>
</div>

<script>
  // Fetch Discord invite data to get approximate member count
  async function fetchDiscordWidget() {
    const widgets = document.querySelectorAll('.discord-widget');

    for (const widget of widgets) {
      const inviteCode = widget.getAttribute('data-invite');
      if (!inviteCode) continue;

      try {
        // Use Discord's invite endpoint which returns member counts
        const response = await fetch(`https://discord.com/api/v9/invites/${inviteCode}?with_counts=true`);

        if (response.ok) {
          const data = await response.json();
          const memberCount = data.approximate_member_count;
          const onlineCount = data.approximate_presence_count;

          const countEl = widget.querySelector('.discord-member-count');
          const dotEl = widget.querySelector('.discord-online-dot');

          if (countEl && memberCount) {
            // Format the count nicely
            const formattedCount = memberCount >= 1000
              ? `${(memberCount / 1000).toFixed(1)}k`
              : memberCount.toString();

            countEl.textContent = `${formattedCount} members`;

            // Show online indicator if we have online count
            if (dotEl && onlineCount > 0) {
              dotEl.classList.remove('hidden');
              countEl.textContent += ` Â· ${onlineCount} online`;
            }
          }
        }
      } catch (error) {
        // Silently fail - fallback text will remain
        console.debug('Discord widget fetch failed:', error);
      }
    }
  }

  // Run on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', fetchDiscordWidget);
  } else {
    fetchDiscordWidget();
  }
</script>
