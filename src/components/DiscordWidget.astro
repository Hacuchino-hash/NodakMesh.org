---
// Discord Widget Component
// Fetches member count at build time from Discord invite API
// Requires widget to be enabled in Discord server settings

interface Props {
  size?: 'sm' | 'md' | 'lg';
  className?: string;
}

const { size = 'md', className = '' } = Astro.props;

const DISCORD_INVITE = 'JUBrZepkaM';

// Size classes
const sizeClasses = {
  sm: 'text-xs',
  md: 'text-sm',
  lg: 'text-base'
};

// Fetch Discord member count at build time
let memberCount = 85; // Fallback
let onlineCount = 0;

try {
  const response = await fetch(`https://discord.com/api/v9/invites/${DISCORD_INVITE}?with_counts=true`);
  if (response.ok) {
    const data = await response.json();
    memberCount = data.approximate_member_count || memberCount;
    onlineCount = data.approximate_presence_count || 0;
  }
} catch (error) {
  console.warn('Discord API fetch failed at build time, using fallback count');
}

// Format count
const formattedCount = memberCount >= 1000
  ? `${(memberCount / 1000).toFixed(1)}k`
  : memberCount.toString();

const displayText = onlineCount > 0
  ? `${formattedCount} members Â· ${onlineCount} online`
  : `${formattedCount} members`;
---

<div class={`discord-widget inline-flex items-center gap-2 ${sizeClasses[size]} ${className}`}>
  <span class="discord-online-dot w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
  <span class="discord-member-count text-[--color-text-muted]">
    {displayText}
  </span>
</div>
